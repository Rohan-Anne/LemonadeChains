{% extends 'base.html' %}

{% block title %}{{ ticker }}{% endblock %}

{% block content %}
<style>
  .navbar-custom { background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .hero-section { background: linear-gradient(135deg, #3498db, #8e44ad); color: white; padding: 50px 0; text-align: center; }
  .card { box-shadow: 0 4px 6px rgba(3, 2, 2, 0.1); margin-bottom: 20px; }
  .btn-custom { background-color: #3498db; border-color: #3498db; color: white; }
  .btn-custom:hover { background-color: #8e44ad; border-color: #8e44ad; color: white; }
  .central-chart-container { width: 100%; height: 400px; margin-top: 20px; position: relative; }
  #tradingview-chart { height: 100% !important; }
  .trade-forms { margin-top: 20px; }
  .trade-form { margin-bottom: 20px; }
  .expanded { max-height: none; }
  /* Watchlist Mini TradingView Charts */
  .tv-widget-mini { width: 100%; height: 130px; }  /* Increased height for better visibility */
  .watchlist-item .tv-widget-mini { height: 120px; margin-bottom: 5px; }
  .stock-info { display: flex; flex-direction: column; }
</style>

<header class="hero-section">
  <div class="container">
    <h1 class="display-4">{{ name }} ({{ ticker }})</h1>
    <h2 id="current-price" class="mt-4">${{ current_price }}</h2>
  </div>
</header>

<main class="container my-5">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title h5 mb-0">{{ ticker }} Stock Overview</h2>
        </div>
        <div class="card-body">
          <!-- TradingView Chart Container -->
          <div class="central-chart-container">
            <div id="tradingview-chart"></div>
          </div>

          <p class="mt-4 description" id="description">{{ description }}</p>
          <span class="show-more" id="show-more" onclick="toggleDescription()">Show More</span>

          <button class="btn btn-custom mt-4" onclick="addToWatchlist('{{ ticker }}')">Add to Watchlist</button>
          <button class="btn btn-danger mt-4" onclick="removeFromWatchlist('{{ ticker }}')">Remove from Watchlist</button>

          <a class="btn btn-custom mt-4" href="{{ url_for('options_detail', ticker=ticker) }}">View Options Data</a>

          <div class="trade-forms">
            <form class="trade-form" onsubmit="addToCart('{{ ticker }}', 'buy', event)">
              <div class="form-group">
                <label for="buy-quantity">Buy Quantity:</label>
                <input type="number" id="buy-quantity" class="form-control" placeholder="Enter quantity" required>
              </div>
              <button type="submit" class="btn btn-success">Buy in Cart</button>
            </form>

            <form class="trade-form" onsubmit="addToCart('{{ ticker }}', 'sell', event)">
              <div class="form-group">
                <label for="sell-quantity">Sell Quantity:</label>
                <input type="number" id="sell-quantity" class="form-control" placeholder="Enter quantity" required>
              </div>
              <button type="submit" class="btn btn-danger">Sell in Cart</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card watchlist-container">
        <div class="card-header">
          <h2 class="card-title h5 mb-0 watchlist-title">Your Watchlist</h2>
        </div>
        <div class="card-body watchlist-scroll">
          <ul id="watchlist" class="list-group">
            {% for item in watchlist %}
            <li class="list-group-item watchlist-item" id="watchlist-item-{{ item }}">
              <div class="stock-info">
                <a href="{{ url_for('stock_detail', ticker=item) }}" class="stock-link">
                  <div>{{ item }}</div>
                </a>
                <div class="stock-price" id="price-{{ item }}"></div>
              </div>
              <!-- TradingView Mini Chart -->
              <div id="mini-chart-{{ item }}" class="tv-widget-mini"></div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Include TradingView Widget Script -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<script>
  // Function to initialize TradingView chart for the main stock
  function loadTradingViewChart(ticker) {
    new TradingView.widget({
      "container_id": "tradingview-chart",
      "autosize": true,
      "symbol": ticker,
      "interval": "D",
      "timezone": "Etc/UTC",
      "theme": "light",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "details": true,
      "studies": ["RSI@tv-basicstudies"],
      "show_popup_button": true,
      "popup_width": "1000",
      "popup_height": "650"
    });
  }

  // Function to initialize TradingView mini chart for each watchlist item
  function loadMiniChart(ticker) {
    new TradingView.widget({
      "container_id": `mini-chart-${ticker}`,
      "symbol": ticker,
      "width": "100%",
      "height": "130",  /* Increased height for better readability */
      "locale": "en",
      "dateRange": "1M",
      "colorTheme": "light",
      "trendLineColor": "#37a6ef",
      "underLineColor": "rgba(55, 166, 239, 0.15)",
      "isTransparent": true,
      "autosize": true,
      "largeChartUrl": ""
    });
  }

  // Lazy Loading Optimization using IntersectionObserver
  function loadWatchlistCharts() {
    const watchlistItems = document.querySelectorAll('.list-group-item.watchlist-item');
    const observer = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const ticker = entry.target.id.replace('watchlist-item-', '');
          loadMiniChart(ticker);  // Load TradingView mini chart directly
          observer.unobserve(entry.target);  // Stop observing once it's loaded
        }
      });
    });

    watchlistItems.forEach(item => observer.observe(item));  // Observe each watchlist item
  }

  function addToCart(ticker, action, event) {
    event.preventDefault();
    const quantity = action === 'buy' ? document.getElementById('buy-quantity').value : document.getElementById('sell-quantity').value;

    const cartItem = {
        type: 'stock',
        contract: ticker,
        action: action,
        quantity: quantity
    };

    fetch('/add_to_cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartItem)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Item added to cart');
        } else {
            alert('Error adding to cart');
        }
    })
    .catch(error => console.error('Error:', error));
  }

  function toggleDescription() {
    const description = document.getElementById('description');
    const showMore = document.getElementById('show-more');

    if (description.classList.contains('expanded')) {
      description.classList.remove('expanded');
      showMore.textContent = 'Show More';
    } else {
      description.classList.add('expanded');
      showMore.textContent = 'Show Less';
    }
  }

  function updateCurrentPrice(ticker) {
  fetch(`/get_stock_price?ticker=${ticker}`)
    .then(response => response.json())
    .then(data => {
      if (data.price) {
        document.getElementById('current-price').textContent = `$${data.price}`;
      } else {
        console.error('Error: No price returned from API');
      }
    })
    .catch(error => console.error('Error fetching current stock/ETF price:', error));
}

  document.addEventListener('DOMContentLoaded', function() {
    loadTradingViewChart('{{ ticker }}');  // Load TradingView chart for the stock
    updateCurrentPrice('{{ ticker }}')
    setInterval(() => updateCurrentPrice('{{ ticker }}'), 30000);  // Refresh the price every 30 seconds
    loadWatchlistCharts();  // Load TradingView mini charts for the watchlist with lazy loading
  });


</script>

{% endblock %}













