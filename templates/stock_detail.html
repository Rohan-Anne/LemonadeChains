{% extends 'base.html' %}

{% block title %}{{ ticker }}{% endblock %}

{% block content %}
<style>
  .navbar-custom { background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .hero-section { background: linear-gradient(135deg, #3498db, #8e44ad); color: white; padding: 50px 0; text-align: center; }
  .card { box-shadow: 0 4px 6px rgba(3, 2, 2, 0.1); margin-bottom: 20px; }
  .btn-custom { background-color: #3498db; border-color: #3498db; color: white; }
  .btn-custom:hover { background-color: #8e44ad; border-color: #8e44ad; color: white; }
  .central-chart-container { width: 100%; height: 300px; margin-top: 20px; }
  .trade-forms { margin-top: 20px; }
  .trade-form { margin-bottom: 20px; }
  .expanded { max-height: none; }
</style>

<header class="hero-section">
  <div class="container">
    <h1 class="display-4">{{ name }} ({{ ticker }})</h1>
    <h2 id="current-price" class="mt-4">${{ current_price }}</h2>
  </div>
</header>

<main class="container my-5">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title h5 mb-0">{{ ticker }} Stock Overview</h2>
        </div>
        <div class="card-body">
          <div class="central-chart-container">
            <canvas id="stockChart"></canvas>
          </div>

          <p class="mt-4 description" id="description">{{ description }}</p>
          <span class="show-more" id="show-more" onclick="toggleDescription()">Show More</span>

          <button class="btn btn-custom mt-4" onclick="addToWatchlist('{{ ticker }}')">Add to Watchlist</button>
          <button class="btn btn-danger mt-4" onclick="removeFromWatchlist('{{ ticker }}')">Remove from Watchlist</button>

          <a class="btn btn-custom mt-4" href="{{ url_for('options_detail', ticker=ticker) }}">View Options Data</a>

          <div class="trade-forms">
            <form class="trade-form" onsubmit="addToCart('{{ ticker }}', 'buy', event)">
              <div class="form-group">
                <label for="buy-quantity">Buy Quantity:</label>
                <input type="number" id="buy-quantity" class="form-control" placeholder="Enter quantity" required>
              </div>
              <button type="submit" class="btn btn-success">Buy in Cart</button>
            </form>

            <form class="trade-form" onsubmit="addToCart('{{ ticker }}', 'sell', event)">
              <div class="form-group">
                <label for="sell-quantity">Sell Quantity:</label>
                <input type="number" id="sell-quantity" class="form-control" placeholder="Enter quantity" required>
              </div>
              <button type="submit" class="btn btn-danger">Sell in Cart</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card watchlist-container">
        <div class="card-header">
          <h2 class="card-title h5 mb-0 watchlist-title">Your Watchlist</h2>
        </div>
        <div class="card-body watchlist-scroll">
          <ul id="watchlist" class="list-group">
            {% for item in watchlist %}
            <li class="list-group-item watchlist-item" id="watchlist-item-{{ item }}">
              <div class="stock-info">
                <a href="{{ url_for('stock_detail', ticker=item) }}" class="stock-link">
                  <div>{{ item }}</div>
                </a>
                <div class="stock-price" id="price-{{ item }}"></div>
              </div>
              <div class="chart-container">
                <canvas id="chart-{{ item }}"></canvas>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function updateCurrentPrice(ticker) {
    fetch(`/get_stock_price?ticker=${ticker}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('current-price').textContent = `$${data.price}`;
        updateCentralStockChart(ticker, data.prices);
      })
      .catch(error => console.error('Error fetching current stock price:', error));
  }

  function updateCentralStockChart(ticker, prices) {
    const ctx = document.getElementById('stockChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length: prices.length}, (_, i) => `Day ${i + 1}`),
        datasets: [{
          label: `${ticker} Price`,
          data: prices,
          borderColor: '#3498db',
          fill: false,
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }

  function updateWatchlistPrices() {
    document.querySelectorAll('.list-group-item.watchlist-item').forEach(function(item) {
      const ticker = item.id.replace('watchlist-item-', '');
      fetch(`/get_stock_price?ticker=${ticker}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById(`price-${ticker}`).textContent = `$${data.price}`;
          updateWatchlistChart(ticker, data.prices);
        })
        .catch(error => console.error('Error fetching watchlist stock price:', error));
    });
  }

  function updateWatchlistChart(ticker, prices) {
    const ctx = document.getElementById(`chart-${ticker}`).getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length: prices.length}, (_, i) => `Day ${i + 1}`),
        datasets: [{
          label: `${ticker} Price`,
          data: prices,
          borderColor: '#8e44ad',
          fill: false,
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  }

  function addToCart(ticker, action, event) {
    event.preventDefault();
    const quantity = action === 'buy' ? document.getElementById('buy-quantity').value : document.getElementById('sell-quantity').value;

    const cartItem = {
        type: 'stock',
        contract: ticker,
        action: action,
        quantity: quantity
    };

    fetch('/add_to_cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartItem)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Item added to cart');
        } else {
            alert('Error adding to cart');
        }
    })
    .catch(error => console.error('Error:', error));
  }

  function toggleDescription() {
    const description = document.getElementById('description');
    const showMore = document.getElementById('show-more');

    if (description.classList.contains('expanded')) {
      description.classList.remove('expanded');
      showMore.textContent = 'Show More';
    } else {
      description.classList.add('expanded');
      showMore.textContent = 'Show Less';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    updateCurrentPrice('{{ ticker }}');
    setInterval(() => updateCurrentPrice('{{ ticker }}'), 30000);
    updateWatchlistPrices();
    setInterval(updateWatchlistPrices, 30000);
  });
</script>

{% endblock %}








