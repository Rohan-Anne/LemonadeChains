<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Options Detail</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    {% extends 'base.html' %}

    {% block title %}Options for {{ ticker }}{% endblock %}

    {% block content %}
    <style>
      .table-container { margin-top: 20px; }
      .filter-container { margin-bottom: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; }
      .filter-group { margin-bottom: 10px; }
      .graph-and-trade-container { display: flex; margin-top: 10px; justify-content: center; }
      .graph-container { flex: 2; margin-right: 10px; height: 600px; width: 80%; display: none; text-align: center; }
    </style>

    <div class="container">
      <h1 class="mt-4">{{ ticker }} Options</h1>
      <!-- Filter Section -->
      <div class="filter-container">
        <div class="filter-group">
          <label for="expiration-date">Expiration Date:</label>
          <select id="expiration-date" class="form-control">
            {% for date in expiration_dates %}
              <option value="{{ date }}">{{ date }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label for="strike-range">Strike Price Range:</label>
          <input type="number" id="strike-min" class="form-control" placeholder="Min Strike">
          <input type="number" id="strike-max" class="form-control" placeholder="Max Strike">
        </div>
        <div class="filter-group">
          <label for="option-type">Option Type:</label>
          <select id="option-type" class="form-control">
            <option value="both">Both</option>
            <option value="call">Calls</option>
            <option value="put">Puts</option>
          </select>
        </div>
        <div class="filter-group">
          <button id="apply-filters" class="btn btn-primary">Apply Filters</button>
        </div>
      </div>

      <!-- Calls Options Table -->
      <div class="table-container">
        <h3>Call Options</h3>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Contract Name</th>
              <th>Last Trade Date</th>
              <th>Strike</th>
              <th>Last Price</th>
              <th>Bid</th>
              <th>Ask</th>
              <th>Change</th>
              <th>% Change</th>
              <th>Volume</th>
              <th>Open Interest</th>
              <th>Implied Volatility</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="calls-table-body">
            <!-- Call options will be loaded here -->
          </tbody>
        </table>
      </div>

      <!-- Puts Options Table -->
      <div class="table-container">
        <h3>Put Options</h3>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Contract Name</th>
              <th>Last Trade Date</th>
              <th>Strike</th>
              <th>Last Price</th>
              <th>Bid</th>
              <th>Ask</th>
              <th>Change</th>
              <th>% Change</th>
              <th>Volume</th>
              <th>Open Interest</th>
              <th>Implied Volatility</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="puts-table-body">
            <!-- Put options will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      document.getElementById('apply-filters').addEventListener('click', function() {
        const ticker = '{{ ticker }}';
        const expirationDate = document.getElementById('expiration-date').value;
        const strikeMin = document.getElementById('strike-min').value;
        const strikeMax = document.getElementById('strike-max').value;
        const optionType = document.getElementById('option-type').value;

        const filters = {
            ticker: ticker,
            expiration_date: expirationDate,
            strike_price_range: strikeMin && strikeMax ? [parseFloat(strikeMin), parseFloat(strikeMax)] : null,
            option_type: optionType
        };

        fetch('/get_options_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching options data:', data.error);
            } else {
                populateTable('calls-table-body', data.calls, 'call', expirationDate);
                populateTable('puts-table-body', data.puts, 'put', expirationDate);
            }
        })
        .catch(error => console.error('Error fetching options data:', error));
      });

      function populateTable(tableBodyId, data, optionType, expirationDate) {
        const tableBody = document.getElementById(tableBodyId);
        tableBody.innerHTML = '';  // Clear the table body

        data.forEach(option => {
            const expiration = new Date(expirationDate).toLocaleDateString('en-US') + ', 11:59:59 PM';
            const graphId = `${option.contractSymbol}-${option.strike}-${expiration}-${optionType}-graph`;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${option.contractSymbol}</td>
                <td>${new Date(option.lastTradeDate).toLocaleString()}</td>
                <td>${option.strike}</td>
                <td>${option.lastPrice}</td>
                <td>${option.bid}</td>
                <td>${option.ask}</td>
                <td>${option.change}</td>
                <td>${option.percentChange}</td>
                <td>${option.volume}</td>
                <td>${option.openInterest}</td>
                <td>${option.impliedVolatility}%</td>
                <td>
                  <button class="btn btn-success" onclick="addToCart('${option.contractSymbol}', ${option.strike}, '${optionType}', '${expiration}', 'buy')">Buy in Cart</button>
                  <button class="btn btn-danger" onclick="addToCart('${option.contractSymbol}', ${option.strike}, '${optionType}', '${expiration}', 'sell')">Sell in Cart</button>
                  <button class="btn btn-secondary" onclick="toggleProfitGraph('${option.contractSymbol}', ${option.strike}, '${optionType}', '${expiration}', '${graphId}')">Toggle Graph</button>
                </td>
            `;
            tableBody.appendChild(row);

            // Add a graph container only
            const graphRow = document.createElement('tr');
            graphRow.innerHTML = `
                <td colspan="12">
                    <div class="graph-and-trade-container">
                        <div id="${graphId}" class="graph-container"></div>
                    </div>
                </td>
            `;
            tableBody.appendChild(graphRow);
        });
      }

      function toggleProfitGraph(ticker, strike, type, expiration, graphId) {
        const graphRow = document.getElementById(graphId);

        if (!graphRow) {
            console.error(`Element with ID ${graphId} not found.`);
            return;
        }

        if (graphRow.style.display === 'block') {
            graphRow.style.display = 'none'; // Hide the graph if already displayed
        } else {
            const payload = {
                ticker: ticker,
                strike: strike,
                expiration: expiration,
                type: type
            };

            fetch('/get_option_profit_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(`Error generating graph: ${data.error}`);
                } else {
                    const stockPriceRange = data.stock_price_range;
                    const profits = data.profits;

                    if (stockPriceRange && profits && stockPriceRange.length > 0 && profits.length > 0) {
                        const graphData = [
                            {
                                x: stockPriceRange,
                                y: profits,
                                type: 'scatter',
                                mode: 'lines',
                                name: 'Profit/Loss'
                            }
                        ];

                        const layout = {
                            title: 'Profit/Loss Graph',
                            xaxis: { title: 'Stock Price' },
                            yaxis: { title: 'Profit/Loss' }
                        };

                        Plotly.newPlot(graphId, graphData, layout);
                        graphRow.style.display = 'block';  // Show the graph
                    } else {
                        console.warn('Received empty or invalid graph data.');
                    }
                }
            })
            .catch(error => console.error('Error fetching graph data:', error));
        }
      }

      function addToCart(contract, strike, type, expiration, action) {
        const cartItem = {
            type: 'option',
            contract: contract,
            strike: strike,
            expiration: expiration,
            action: action
        };
        fetch('/add_to_cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cartItem)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Item added to cart');
            } else {
                alert('Error adding to cart');
            }
        })
        .catch(error => console.error('Error:', error));
      }

      // Automatically apply filters on page load to show initial data
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('apply-filters').click();
      });
    </script>
    {% endblock %}
</body>
</html>

